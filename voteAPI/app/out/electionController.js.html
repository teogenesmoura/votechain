<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: electionController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: electionController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>let Election = require('../models/election');
let Voter = require('../models/voter');
let Vote = require('../models/vote');
let Votechain = require('../models/votechain');
let votechainController = require('./votechainController');
let voteController = require('./voteController');
let voterController = require('./voterController');
let async = require('async');

function initializeElection(req, res) {
	let election = new Election();
	let votechain = new Votechain();
	votechain.election = election;
	votechain.save(function(err) {
		election.name		= req.body.name;
		election.voters		= [];
		election.votechain  = votechain.id;
		election.save(function(err) {
			if(err) res.send(err);
			res.json(election);
		});
	});
}
/**
* Retrieves all elections
* @returns error if an error occurs or the a JSON document containing all elections
*/
function getElection(req, res) {
	let query = Election.find({});
	query.exec((err, elections) => {
		if(err) res.send(err);
		res.json(elections);
	}); 
}
/**
* Adds a voter to an Election
* @param {string} electionName - the name of the election receiving the voter
* @param {string} voterName - the unique name of the voter to add
* @returns error if an error occurs or the new voter document hence the need of new: true
*/
function addVoterToElection(req, res) {
	async.parallel(
	{
		voter: function(callback) {
			Voter.findOne({ 'name' : req.body.voterName }, function(err,voter) {
				callback(err, voter);
			});
		}
	},
	function(e, r) {
		if(r.voter === null){ 
			res.send('Voter not found');
		} else {
		Election.findOneAndUpdate(
			{'name': req.body.electionName },
			{$push: { voters: r.voter }},
			{new: true},
			function(err, voter) {
				if(err) res.send(err);
				res.send(voter);
					}
				);
			}
		}
	);
}
/**
* Casts a vote to a candidate in a given election
* @param {string} req.body.election - the name of the election receiving the vote
* @param {string} req.body.voter - the unique name of the voter who will cast the vote
* @param {string} req.body.candidate - the unique name of the candidate who will receive the vote
* @returns error if an error occurs or the updated votechain for that election
*/
function castVoteToCandidateInElection(req, res) {
	async.parallel(
	{
		voter: function(callback) {
			Voter.findOne({ 'name' : req.body.voter }, function(err,voter) {
				callback(err, voter);
			});
		},
		election: function(callback) {
			Election.findOne({ 'name' : req.body.election }, function(err,election) {
				callback(err, election);
			});
		},
		candidate: function(callback) {
			Voter.findOne({ 'name' : req.body.candidate }, function(err, candidate) {
				callback(err, candidate);
			});
		} 
	}, function(e, r) {
		if(r.voter === null || r.election === null || r.candidate === null) {
			res.send('Voter,Election or Candidate not found');
		} else {
			let mVote = new Vote();
			mVote.voter = r.voter;
			mVote.candidate = r.candidate;
			mVote.save(function(err, mVote){
				Votechain.findOneAndUpdate(
					{ 'election' : r.election },
					{ $push: { votes: mVote }},
					{ new: true},
					function(err, votechain) {
						if(err) res.send(err);
						res.json(votechain);
						}			
					);
				});
			}
		}
	);
}
/**
* Gets a chain of votes linked to a given election 
* @param {Number} req.body.electionID - the ID of the given Election
* @returns error if an error occur or the votechain instance requested
*/
function getVotechainFromElection(req, res) {
	let electionID = req.body.electionID;

}
module.exports = { initializeElection, getElection, addVoterToElection, castVoteToCandidateInElection };

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addVoterToElection">addVoterToElection</a></li><li><a href="global.html#castVoteToCandidateInElection">castVoteToCandidateInElection</a></li><li><a href="global.html#getElection">getElection</a></li><li><a href="global.html#getVotechainFromElection">getVotechainFromElection</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Tue Jun 27 2017 11:44:39 GMT-0300 (-03)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
